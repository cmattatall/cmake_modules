cmake_minimum_required(VERSION 3.21)

file(GLOB_RECURSE TEST_SOURCE_CMAKELISTS "*/CMakeLists\.txt")

foreach(CMAKELISTS ${TEST_SOURCE_CMAKELISTS})
    get_filename_component(CMAKELISTS_SOURCE_DIR ${CMAKELISTS} DIRECTORY)
    file(RELATIVE_PATH CMAKELISTS_PATH_MODULE_RELATIVE ${PROJECT_SOURCE_DIR} ${CMAKELISTS_SOURCE_DIR})
    file(TO_CMAKE_PATH ${CMAKELISTS_PATH_MODULE_RELATIVE} CMAKELISTS_PATH_RELATIVE_AS_CMAKE_PATH)
    string(REPLACE "/" "_" TEST_NAME "${CMAKELISTS_PATH_RELATIVE_AS_CMAKE_PATH}")
    string(REPLACE "\ " "_" TEST_NAME ${TEST_NAME})
    string(REPLACE "\t" "_" TEST_NAME ${TEST_NAME}) # If you put tabs in filepaths please go see a psychiatrist ...
    set(TEST_NAME "${PROJECT_NAME}_${TEST_NAME}")

    file(RELATIVE_PATH CMAKELISTS_SOURCE_DIR_CURRENT_RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKELISTS_SOURCE_DIR})
    set(CURRENT_TEST_BINARY_DIR ${CMAKE_CURRENT_BINARY_DIR}/build/${CMAKELISTS_SOURCE_DIR_CURRENT_RELATIVE})
    file(REMOVE ${CURRENT_TEST_BINARY_DIR}) # Remove in case of caching from previous run

    add_test(
        NAME ${TEST_NAME}_configure
        COMMAND ${CMAKE_COMMAND} -S ${CMAKELISTS_SOURCE_DIR} -B ${CURRENT_TEST_BINARY_DIR} -DCMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH} 
    )   
endforeach(CMAKELISTS ${TEST_SOURCE_CMAKELISTS})
